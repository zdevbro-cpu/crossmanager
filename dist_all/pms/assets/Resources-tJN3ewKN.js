import{a as N,e as _,u as I,f as j,b as R,r as k,j as e}from"./index-CV60rgYO.js";import{u as w}from"./useMutation-HjsCWOAi.js";import{P as $,T as D}from"./trash-2-CoTpdRSx.js";import{c as M}from"./createLucideIcon-xPnhNdih.js";const Q=[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]],C=M("truck",Q);const z=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],q=M("users",z),F=()=>I({queryKey:["users"],queryFn:async()=>{const{data:t}=await j.get("/users");return t.filter(r=>r.status==="approved")}}),O=()=>I({queryKey:["personnel"],queryFn:async()=>{const{data:t}=await j.get("/personnel");return t}}),L=()=>I({queryKey:["equipment"],queryFn:async()=>{const{data:t}=await j.get("/equipment");return t}}),W=()=>{const{selectedId:t}=N();return I({queryKey:["resource-assignments",t],queryFn:async()=>{const r=t?{projectId:t}:{},{data:c}=await j.get("/resource-assignments",{params:r});return c}})},K=()=>{const{selectedId:t}=N(),r=F(),c=O(),d=L(),o=W(),y=r.isLoading||c.isLoading||d.isLoading||o.isLoading,h=r.isError||c.isError||d.isError||o.isError,m=[],x=r.data||[],n=c.data||[],u=d.data||[],g=o.data||[];return x.forEach(l=>{const p=g.filter(a=>a.resource_type==="PERSON"&&a.resource_id===l.uid).map(a=>({taskId:"",start:a.start_date,end:a.end_date,assignmentId:a.id}));m.push({id:l.uid,type:"인력",name:l.name||l.email,projectId:t||"",assignments:p,conflicts:[]})}),n.forEach(l=>{const p=g.filter(a=>a.resource_type==="PERSON"&&a.resource_id===l.id).map(a=>({taskId:"",start:a.start_date,end:a.end_date,assignmentId:a.id}));m.push({id:l.id,type:"인력",name:l.name+(l.role?` (${l.role})`:""),projectId:t||"",assignments:p,conflicts:[]})}),u.forEach(l=>{const p=g.filter(a=>a.resource_type==="EQUIPMENT"&&a.resource_id===l.id).map(a=>({taskId:"",start:a.start_date,end:a.end_date,assignmentId:a.id}));m.push({id:l.id,type:"장비",name:l.name,projectId:t||"",assignments:p,conflicts:[]})}),{data:m,isLoading:y,isError:h,users:x,equipment:u,personnel:n}},B=()=>{const t=_(),{selectedId:r}=N(),c=w({mutationFn:async o=>{const y={projectId:r,resourceType:o.resourceType,resourceId:o.resourceId,startDate:o.startDate,endDate:o.endDate},{data:h}=await j.post("/resource-assignments",y);return h},onSuccess:()=>{t.invalidateQueries({queryKey:["resource-assignments",r]})}}),d=w({mutationFn:async o=>{await j.delete(`/resource-assignments/${o}`)},onSuccess:()=>{t.invalidateQueries({queryKey:["resource-assignments",r]})}});return{createAssignment:c,deleteAssignment:d}};function b(t){if(!t)return"";if(t.length===10)return t;const r=new Date(t),c=r.getFullYear(),d=String(r.getMonth()+1).padStart(2,"0"),o=String(r.getDate()).padStart(2,"0");return`${c}-${d}-${o}`}function A(t){if(!t)return"";const r=new Date(t),c=String(r.getMonth()+1).padStart(2,"0"),d=String(r.getDate()).padStart(2,"0");return`${c}.${d}`}function U(t){const r=[];for(let c=0;c<t.length;c+=1)for(let d=c+1;d<t.length;d+=1){const o=t[c],y=t[d],h=new Date(o.start).getTime(),m=new Date(o.end).getTime(),x=new Date(y.start).getTime(),n=new Date(y.end).getTime();if(h<=n&&x<=m){const u=Math.max(h,x),g=Math.min(m,n),l=Math.abs(g-u),p=Math.ceil(l/(1e3*60*60*24))+1,a=new Date(u).toISOString(),v=new Date(g).toISOString();r.push(`${A(a)} ~ ${A(v)} (${p}일간)`)}}return r}function J(){const{show:t}=R(),{data:r=[],isLoading:c,isError:d,users:o,equipment:y,personnel:h}=K(),{createAssignment:m,deleteAssignment:x}=B(),[n,u]=k.useState({resourceType:"PERSON",resourceId:"",start:"",end:""}),g=k.useMemo(()=>r.filter(s=>s.assignments.length>0).map(s=>({...s,conflicts:U(s.assignments)})),[r]),l=g.filter(s=>s.type==="인력"),p=g.filter(s=>s.type==="장비"),a=[...(o||[]).map(s=>({id:s.uid,name:s.name||s.email,source:"user"})),...(h||[]).map(s=>({id:s.id,name:s.name+(s.role?` (${s.role})`:""),source:"personnel"}))],v=async s=>{if(s.preventDefault(),!n.resourceId||!n.start||!n.end){t("자원과 기간을 모두 선택하세요.","warning");return}try{await m.mutateAsync({resourceType:n.resourceType,resourceId:n.resourceId,startDate:n.start,endDate:n.end}),t("배정이 추가되었습니다.","success"),u(i=>({...i,resourceId:"",start:"",end:""}))}catch(i){console.error(i),t("배정 추가 실패","error")}},S=async s=>{if(s&&confirm("이 배정을 삭제하시겠습니까?"))try{await x.mutateAsync(s),t("배정이 삭제되었습니다.","success")}catch{t("삭제 실패","error")}},T={display:"flex",alignItems:"center",gap:6,padding:"0.5rem 1rem",borderRadius:"10px",border:"1px solid rgba(71, 85, 105, 0.5)",background:"#475569",color:"#f2f5ff",cursor:"pointer",fontWeight:500,boxShadow:"0 4px 12px rgba(0, 0, 0, 0.2)"},E={display:"flex",alignItems:"center",gap:6,padding:"0.5rem 1rem",borderRadius:"10px",border:"1px solid rgba(255, 255, 255, 0.07)",background:"rgba(255, 255, 255, 0.02)",color:"#c6d5f0",cursor:"pointer",fontWeight:400},P={colorScheme:"dark"};return e.jsxs("div",{className:"page",children:[e.jsxs("header",{className:"section-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"자원(장비/인력)"}),e.jsx("h2",{children:"자원 배정 및 중복 관리"}),e.jsx("p",{className:"muted",children:"인력과 장비를 작업에 배정하고, 일정 중복을 확인하세요."})]}),e.jsx("div",{className:"pill pill-outline",children:"배정 현황"})]}),e.jsxs("section",{className:"card",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[e.jsx("p",{className:"card-label",style:{margin:0},children:"배정 추가"}),e.jsx("button",{type:"button",onClick:s=>{const i=s.currentTarget.closest("section")?.querySelector("form");i&&i.requestSubmit()},disabled:m.isPending,title:"배정 추가",style:{width:40,height:40,display:"flex",alignItems:"center",justifyContent:"center",background:"transparent",border:"1px solid rgba(255, 255, 255, 0.15)",borderRadius:"6px",color:"#94a3b8",cursor:"pointer"},children:e.jsx($,{size:20})})]}),e.jsxs("form",{className:"form-grid",onSubmit:v,style:{alignItems:"end",gridTemplateColumns:"auto 1fr 1fr 1fr"},children:[e.jsxs("label",{children:[e.jsx("span",{children:"자원 유형"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{type:"button",onClick:()=>u({...n,resourceType:"PERSON",resourceId:""}),style:n.resourceType==="PERSON"?T:E,children:[e.jsx(q,{size:14})," 인력"]}),e.jsxs("button",{type:"button",onClick:()=>u({...n,resourceType:"EQUIPMENT",resourceId:""}),style:n.resourceType==="EQUIPMENT"?T:E,children:[e.jsx(C,{size:14})," 장비"]})]})]}),e.jsxs("label",{children:[e.jsx("span",{children:n.resourceType==="PERSON"?"인력 선택":"장비 선택"}),e.jsxs("select",{value:n.resourceId,onChange:s=>u({...n,resourceId:s.target.value}),style:P,children:[e.jsx("option",{value:"",children:"선택"}),n.resourceType==="PERSON"?a.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)):(y||[]).map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.category||"기타",")"]},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"시작일"}),e.jsx("input",{type:"date",value:n.start,onChange:s=>u({...n,start:s.target.value}),style:{colorScheme:"dark"}})]}),e.jsxs("label",{children:[e.jsx("span",{children:"종료일"}),e.jsx("input",{type:"date",value:n.end,onChange:s=>u({...n,end:s.target.value}),style:{colorScheme:"dark"}})]})]})]}),e.jsxs("section",{className:"card table-card",style:{marginTop:"1.5rem"},children:[e.jsx("div",{className:"table-head",children:e.jsxs("p",{className:"card-label",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(q,{size:18})," 인력 배정 현황"]})}),c&&e.jsx("p",{className:"muted",style:{padding:"1rem"},children:"불러오는 중..."}),d&&e.jsx("p",{className:"muted",style:{padding:"1rem"},children:"불러오기 오류"}),e.jsxs("div",{className:"table",children:[e.jsxs("div",{className:"table-row table-header",style:{gridTemplateColumns:"1fr 1.5fr 2.5fr"},children:[e.jsx("span",{children:"이름"}),e.jsx("span",{children:"배정 기간"}),e.jsx("span",{children:"중복"})]}),l.length===0&&!c&&e.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"#94a3b8"},children:"배정된 인력이 없습니다. 위 폼에서 인력을 배정하세요."}),l.map(s=>e.jsxs("div",{className:"table-row",style:{gridTemplateColumns:"1fr 1.5fr 2.5fr"},children:[e.jsx("span",{style:{fontWeight:500},children:s.name}),e.jsx("span",{children:s.assignments.map((i,f)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[e.jsxs("span",{children:[b(i.start)," ~ ",b(i.end)]}),i.assignmentId&&e.jsx("button",{className:"icon-button",onClick:()=>S(i.assignmentId),title:"삭제",style:{padding:4},children:e.jsx(D,{size:14})})]},f))}),e.jsx("span",{style:{textAlign:"left"},children:s.conflicts&&s.conflicts.length>0?e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6,alignItems:"flex-start"},children:[e.jsxs("span",{className:"badge badge-alert",style:{alignSelf:"flex-start"},children:["중복 (",s.conflicts.length,"건)"]}),s.conflicts.map((i,f)=>e.jsxs("span",{style:{fontSize:"0.85rem",color:"#f87171",display:"flex",alignItems:"center",gap:6},children:["• ",i]},f))]}):e.jsx("span",{className:"badge badge-live",children:"정상"})})]},s.id))]})]}),e.jsxs("section",{className:"card table-card",style:{marginTop:"1.5rem"},children:[e.jsx("div",{className:"table-head",children:e.jsxs("p",{className:"card-label",style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(C,{size:18})," 장비 배정 현황"]})}),e.jsxs("div",{className:"table",children:[e.jsxs("div",{className:"table-row table-header",style:{gridTemplateColumns:"1fr 1.5fr 2.5fr"},children:[e.jsx("span",{children:"장비명"}),e.jsx("span",{children:"배정 기간"}),e.jsx("span",{children:"중복"})]}),p.length===0&&!c&&e.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"#94a3b8"},children:"배정된 장비가 없습니다. 위 폼에서 장비를 배정하세요."}),p.map(s=>e.jsxs("div",{className:"table-row",style:{gridTemplateColumns:"1fr 1.5fr 2.5fr"},children:[e.jsx("span",{style:{fontWeight:500},children:s.name}),e.jsx("span",{children:s.assignments.map((i,f)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[e.jsxs("span",{children:[b(i.start)," ~ ",b(i.end)]}),i.assignmentId&&e.jsx("button",{className:"icon-button",onClick:()=>S(i.assignmentId),title:"삭제",style:{padding:4},children:e.jsx(D,{size:14})})]},f))}),e.jsx("span",{style:{textAlign:"left"},children:s.conflicts&&s.conflicts.length>0?e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:6,alignItems:"flex-start"},children:[e.jsxs("span",{className:"badge badge-alert",style:{alignSelf:"flex-start"},children:["중복 (",s.conflicts.length,"건)"]}),s.conflicts.map((i,f)=>e.jsxs("span",{style:{fontSize:"0.85rem",color:"#f87171",display:"flex",alignItems:"center",gap:6},children:["• ",i]},f))]}):e.jsx("span",{className:"badge badge-live",children:"정상"})})]},s.id))]})]})]})}export{J as default};
